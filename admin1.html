<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - North Texas Rentals</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family:'Roboto', sans-serif; margin:0; padding:0; background:#f8f8f8; color:#333; }
header { display:flex; justify-content:space-between; align-items:center; background: linear-gradient(135deg, #ffffff 0%, #f9f9f9 100%); padding:15px 50px; border-bottom:4px solid #d60000; position:sticky; top:0; z-index:1000; box-shadow: 0 4px 12px rgba(0, 0, 50, 0.1); }
.logo-section { display:flex; align-items:center; gap:15px; }
header img { height:55px; transition: transform 0.3s ease; }
header img:hover { transform: scale(1.05); }
.company-name { font-size:24px; font-weight:700; color:#00008b; letter-spacing:0.5px; }
.company-name span { color:#d60000; }
nav { display:flex; align-items:center; gap:5px; }
nav a { text-decoration:none; color:#333; padding:12px 18px; font-weight:600; font-size:15px; transition: all 0.3s ease; border-radius:6px; position:relative; }
nav a:hover { color:#d60000; background-color: rgba(214, 0, 0, 0.08); }
nav a::after { content:''; position:absolute; bottom:8px; left:18px; right:18px; height:2px; background-color:#d60000; transform:scaleX(0); transition: transform 0.3s ease; }
nav a:hover::after { transform:scaleX(1); }
.contact-btn { background: linear-gradient(135deg, #d60000 0%, #b30000 100%); color:white; padding:12px 28px; border-radius:8px; text-decoration:none; font-weight:700; font-size:15px; box-shadow: 0 4px 12px rgba(214, 0, 0, 0.3); transition: all 0.3s ease; border:2px solid #d60000; }
.contact-btn:hover { background: linear-gradient(135deg, #b30000 0%, #9a0000 100%); box-shadow: 0 6px 16px rgba(214, 0, 0, 0.4); transform:translateY(-2px); }
#logoutBtn { background: linear-gradient(135deg, #ff6b6b 0%, #d60000 100%); color:white; padding:12px 28px; border:2px solid #ff6b6b; border-radius:8px; cursor:pointer; font-weight:700; font-size:15px; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3); margin-left:10px; }
#logoutBtn:hover { background: linear-gradient(135deg, #d60000 0%, #b30000 100%); box-shadow: 0 6px 16px rgba(255, 107, 107, 0.4); transform:translateY(-2px); }
.container { max-width:1400px; margin:40px auto; padding:20px; background:white; border-radius:10px; box-shadow:0 4px 15px rgba(0,0,0,0.05); overflow-x:auto; }
h1 { color:#00008b; text-align:center; margin-bottom:30px; }
table { width:100%; border-collapse:collapse; margin-top:20px; font-size:13px; }
th, td { border:1px solid #ddd; padding:12px; text-align:left; }
th { background:#00008b; color:white; font-weight:700; position:sticky; top:0; }
tr:nth-child(even) { background-color:#f9f9f9; }
tr:hover { background-color:#f0f0f0; }
td { word-break:break-word; max-width:150px; }
</style>
</head>
<body>

<header>
<div class="logo-section">
<img src="Logo_north_texas2.0.png" alt="Logo">
<div class="company-name">North Texas <span>Rentals</span></div>
</div>
<nav>
<button id="logoutBtn">Logout</button>
</nav>
</header>

<div class="container">
<h1>Admin Panel - Requests</h1>
    <h2 style="margin-top:0;">Inventory Management</h2>
    <div style="margin-bottom:24px; overflow-x:auto;">
        <table id="inventoryTable" style="width:100%;border-collapse:collapse;margin-bottom:10px;font-size:13px;">
            <thead>
                <tr>
                    <th style="padding:10px;background:#001f7a;color:white;">Machine</th>
                    <th style="padding:10px;background:#001f7a;color:white;">Available</th>
                    <th style="padding:10px;background:#001f7a;color:white;">Actions</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>

    </div>
<table id="requestsTable">
<thead>
<tr>
<th>Full Name</th>
<th>Address</th>
<th>Phone</th>
<th>Email</th>
<th>Machine</th>
<th>Additional Info</th>
<th>User Email</th>
<th>Date</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBI28ZY62HS-snbGfVJN7HJGBdCMRzG0wU",
  authDomain: "northtexas-cfd0f.firebaseapp.com",
  projectId: "northtexas-cfd0f",
  storageBucket: "northtexas-cfd0f.appspot.com",
  messagingSenderId: "1064140086938",
  appId: "1:1064140086938:web:20acaf176ccc23ff200923"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const requestsTableBody = document.querySelector('#requestsTable tbody');
const inventoryTableBody = document.querySelector('#inventoryTable tbody');
const logoutBtn = document.getElementById('logoutBtn');

// List of machines from catalog
const catalogMachines = [
    'Kioti Tractor TL750',
    'Sany Excavator 35u',
    'Kubota Excavator SVL 65-2',
    'Mini Skid Steer SCL 1000',
    'Sany 26u',
    'Backhoe Loader',
    'Telehandler 5k',
    'Vibratory Roller',
    'Dump Truck 10T',
    'Scissor Lift',
    'Motosierra',
    'Pala',
    'Rotomartillo',
    'Taladro',
    'Grapple Bucket'
];

async function loadInventory() {
    inventoryTableBody.innerHTML = '';
    const invSnap = await getDocs(collection(db, 'inventory'));
    
    // If inventory is empty, initialize with catalog machines
    if(invSnap.empty) {
        for(const machineName of catalogMachines) {
            const id = machineName.replace(/\s+/g,'_');
            await setDoc(doc(db, 'inventory', id), { name: machineName, available: 5 }, { merge: true });
        }
        // Reload after initialization
        return loadInventory();
    }
    invSnap.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;
        const row = document.createElement('tr');
        row.innerHTML = `
            <td style="padding:10px;">${data.name || id}</td>
            <td style="padding:10px;"><input type="number" min="0" value="${data.available || 0}" data-id="${id}" class="inv-qty" style="width:90px;padding:6px;border-radius:4px;border:1px solid #ccc;"></td>
            <td style="padding:10px;"><button class="save-inv" data-id="${id}" style="background:#00008b;color:#fff;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;margin-right:6px;">Save</button><button class="delete-inv" data-id="${id}" style="background:#ef4444;color:#fff;padding:6px 10px;border:none;border-radius:6px;cursor:pointer;">Delete</button></td>
        `;
        inventoryTableBody.appendChild(row);
    });

    // attach listeners
    document.querySelectorAll('.save-inv').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            const input = document.querySelector(`.inv-qty[data-id="${id}"]`);
            const val = parseInt(input.value || '0', 10);
            try {
                await updateDoc(doc(db, 'inventory', id), { available: val });
                alert('Inventory updated');
            } catch (err) {
                console.error(err);
                alert('Update failed: ' + err.message);
            }
        });
    });

    document.querySelectorAll('.delete-inv').forEach(btn => {
        btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-id');
            if(!confirm('Delete this inventory item?')) return;
            try {
                // set available to 0 and remove name
                await setDoc(doc(db, 'inventory', id), { name: '', available: 0 });
                await loadInventory();
                alert('Deleted (reset)');
            } catch (err) {
                console.error(err);
                alert('Delete failed: ' + err.message);
            }
        });
    });
}

logoutBtn.addEventListener('click', async () => {
    await signOut(auth);
    window.location.href = 'Login_north_texas_rentals.html';
});

onAuthStateChanged(auth, async (user) => {
    if(user){
        console.log("âœ“ Usuario autenticado:", user.email);
        const adminEmails = ["admin@gmail.com"];
        if(!adminEmails.includes(user.email)){
            console.log("âœ— No es admin");
            alert("Access denied. You are not admin.");
            window.location.href = "North_texas_rentals.html";
            return;
        }

        console.log("âœ“ Usuario es admin, inicializando panel de admin...");
        // Ensure inventory is loaded first
        await loadInventory();

        // Use real-time listener so new requests appear immediately
        const requestsCol = collection(db, 'requests');
        onSnapshot(requestsCol, (snapshot) => {
          console.log("âœ“ Requests snapshot size:", snapshot.size);
          if (snapshot.empty) {
            console.log("âš  No hay requests");
            requestsTableBody.innerHTML = '<tr><td colspan="10">No requests found</td></tr>';
            return;
          }

          // Convert docs to array and sort by date descending on the client
          const docs = snapshot.docs.slice();
          docs.sort((a, b) => {
            const da = a.data().date;
            const dbDate = b.data().date;
            const ta = (da && typeof da.toDate === 'function') ? da.toDate().getTime() : (da instanceof Date ? da.getTime() : (typeof da === 'string' ? Date.parse(da) : 0));
            const tb = (dbDate && typeof dbDate.toDate === 'function') ? dbDate.toDate().getTime() : (dbDate instanceof Date ? dbDate.getTime() : (typeof dbDate === 'string' ? Date.parse(dbDate) : 0));
            return tb - ta;
          });

          // Render rows
          requestsTableBody.innerHTML = '';
          docs.forEach((docSnap, index) => {
            console.log("ðŸ“„ Request", index + 1, ":", docSnap.data());
            const data = docSnap.data();
                let dateStr = "";
                if(data.date) {
                    if(typeof data.date === 'object' && data.date.toDate) {
                        dateStr = data.date.toDate().toLocaleString();
                    } else if(data.date instanceof Date) {
                        dateStr = data.date.toLocaleString();
                    } else if(typeof data.date === 'string') {
                        dateStr = data.date;
                    }
                }
            const row = document.createElement('tr');
            const statusVal = data.status || 'pending';
            row.innerHTML = `
                <td>${data.fullName || ""}</td>
                <td>${data.address || ""}</td>
                <td>${data.phone || ""}</td>
                <td>${data.requestEmail || ""}</td>
                <td>${data.machine || ""}</td>
                <td>${data.message || ""}</td>
                <td>${data.userEmail || ""}</td>
                <td>${dateStr}</td>
                <td>
                    <select data-docid="${docSnap.id}" class="status-select" style="padding:6px;border-radius:4px;border:1px solid #ccc;">
                        <option value="pending">Pending</option>
                        <option value="accepted">Accepted</option>
                        <option value="in_transit">In Transit</option>
                        <option value="declined">Declined</option>
                    </select>
                </td>
                <td>
                    <button class="save-btn" data-docid="${docSnap.id}" style="background:#00008b;color:white;padding:8px 10px;border-radius:6px;border:none;cursor:pointer;margin-right:6px;">Save</button>
                    <button class="toggle-transit" data-docid="${docSnap.id}" style="background:#d60000;color:white;padding:8px 10px;border-radius:6px;border:none;cursor:pointer;">Toggle Transit</button>
                </td>
            `;
            requestsTableBody.appendChild(row);

            // set selected status
            const selectEl = row.querySelector('.status-select');
            if(selectEl) selectEl.value = statusVal;
            // attach listeners
            const saveBtn = row.querySelector('.save-btn');
            const toggleBtn = row.querySelector('.toggle-transit');
            if(saveBtn) {
                saveBtn.addEventListener('click', async () => {
                    const id = saveBtn.getAttribute('data-docid');
                    const newStatus = selectEl.value;
                    const machine = data.machine || '';
                    try {
                        // Check if changing to accepted or in_transit
                        if((newStatus === 'accepted' || newStatus === 'in_transit') && data.status !== newStatus) {
                            // Find inventory doc for this machine
                            const machineId = machine.replace(/\s+/g,'_');
                            const invDocRef = doc(db, 'inventory', machineId);
                            const invDoc = await getDoc(invDocRef);
                            if(invDoc.exists()) {
                                const currentAvailable = invDoc.data().available || 0;
                                if(currentAvailable <= 0) {
                                    // Auto-decline if no stock
                                    selectEl.value = 'declined';
                                    await updateDoc(doc(db, 'requests', id), { status: 'declined' });
                                    alert('No inventory available. Request auto-declined.');
                                    return;
                                }
                                // Subtract 1 from inventory
                                await updateDoc(invDocRef, { available: currentAvailable - 1 });
                            }
                        }

                        await updateDoc(doc(db, 'requests', id), { status: newStatus });
                        alert('Updated successfully');
                        // Reload inventory table
                        await loadInventory();
                    } catch (err) {
                        console.error(err);
                        alert('Update failed: ' + err.message);
                    }
                });
            }

            if(toggleBtn) {
                toggleBtn.addEventListener('click', async () => {
                    const id = toggleBtn.getAttribute('data-docid');
                    try {
                        const current = selectEl.value;
                        const next = current === 'in_transit' ? 'accepted' : 'in_transit';
                        selectEl.value = next;
                        await updateDoc(doc(db, 'requests', id), { status: next });
                        alert('Status changed to ' + next);
                    } catch (err) {
                        console.error(err);
                        alert('Could not change status: ' + err.message);
                    }
                });
            }
          });
        }, (err) => {
          console.error('Requests listener error:', err);
          requestsTableBody.innerHTML = '<tr><td colspan="10">Could not load requests</td></tr>';
        });

    } else {
        console.log("âœ— Usuario no autenticado");
        window.location.href = "North_texas_rentals.html";
    }
});
</script>

</body>
</html>
